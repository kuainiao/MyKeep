<?php
include 'funs.php';
$c=getDatabaseConnect($con);
if($c==-1){
echo "Error.Can't connect the database.";
exit;
}

echo <<<HEAD
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="images/favicon.ico" >
<title>MyKeep</title>

<script language="JavaScript">
function over_btn_bc(x){
document.getElementById(x).style.background="#fff";
}
function out_btn_bc(x){
document.getElementById(x).style.background="#fafafa";
}
</script>

<style>
*{
margin:0;
}
body
{
	background-color:#e8e8e8;
	padding-left:200px;
    padding-right:200px;
    padding-bottom:200px;
}
.add_div{
overflow:hidden;
}
#new_task_input{
border:0;
background-color:#fafafa;
width:100%;
height:100%;
}
.submit_btn{
float:right;
height:100%;
width:100px;
padding:10px;
margin:5px 0;
background-color:#fafafa;
border:0;
}
.add_up_div{
overflow:hidden;
}
.add_up_div{
overflow:hidden;
}
#content_body{
padding:50px 0;
/*border-left:1px solid #444;
border-right:1px solid #444;*/
}
.todo_div{
margin:10px 0px;
padding:5px 10px;
background-color:#fafafa;
overflow:hidden;
}
.todo_id_div{
float:left;
min-width:10%;
color:#777;
}
.todo_content_div{
float:left;
padding-top:10px;
padding-bottom:10px;
min-width:70%;
overflow:hidden;
}
.todo_time_div{
float:right;
min-width:40%;
text-align:right;
color:#777;
}
.todo_done_div{
float:left;
min-width:10%;
}
.todo_up_div{
width:100%;
overflow:hidden;
}
.todo_down_div{
width:100%;
overflow:hidden;
}
.todo_edit_btn{
display:none;
}
</style>
</head>

<body>
<div id="content_body">

HEAD;
/*


*/
/*
<textarea name="new_task_input" id="new_task_input" rows="5" cols="50"></textarea>
*/


echo <<<ADD_TABLE
<div class="add_div">
<div class="add_up_div">
<textarea name="new_task_input" id="new_task_input" rows="5" cols="50"></textarea>
</div>
<div class="add_down_div">
<button type="button"  class="submit_btn" id="submit_btn" onmouseout="out_btn_bc('submit_btn')" onmouseover="over_btn_bc('submit_btn')" onclick="submit()">Add</button>
<div id="info_out"></div>
</div>
</div>
ADD_TABLE;



/*
<table class="todo_table">
<tr>
</tr>
</table>
*/

echo <<<STR

STR;

$sql="SELECT * FROM `tasks` where task_done='N' or task_done='n' ";
$result =$con->query($sql);
if($result){
	while($row = $result->fetch_array()){
	    $done="<input onclick=\"check_done($row[task_id])\" type=\"checkbox\">";


echo <<<STR1

<div class="todo_div">
<div class="todo_up_div">
<div class="todo_done_div">
$done
</div>

<div class="todo_id_div">
$row[task_id]
</div>

<div class="todo_content_div" id="todo_content_div$row[task_id]" onclick="edit($row[task_id])">
$row[task_content]

</div>
</div>
<div class="todo_down_div">
<div class="todo_time_div">
$row[task_add_time]
</div>
</div>
</div>

STR1;
}
}
echo "";
$con->close();

echo<<<FOOT
</div>


<script type="text/javascript">

    //基本函数*2
    var addHandler = window.addEventListener?
    function(elem,event,handler){elem.addEventListener(event,handler);}:
    function(elem,event,handler){elem.attachEvent("on"+event,handler);};

    var $ = function(id){return document.getElementById(id);}


    function autoTextArea(elemid){
        //新建一个textarea用户计算高度
        if(!$("_textareacopy")){
            var t = document.createElement("textarea");
            t.id="_textareacopy";
            t.cols="50";
            t.rows="5";
            t.style.position="absolute";
            t.style.left="-9999px";
            document.body.appendChild(t);
        }
        function change(){
            $("_textareacopy").value= $(elemid).value;
            $(elemid).style.height= $("_textareacopy").scrollHeight+$("_textareacopy").style.height+"px";
        }
        addHandler($("new_task_input"),"propertychange",change);//for IE
        addHandler($("new_task_input"),"input",change);// for !IE
        $(elemid).style.overflow="hidden";//一处隐藏，必须的。
        $(elemid).style.resize="none";//去掉textarea能拖拽放大/缩小高度/宽度功能
    }

    addHandler(window,"load",function(){
        autoTextArea("new_task_input");
    });
</script>






<script language="JavaScript">
function update(id,content){
    var url="update_todo.php";
	var args="id="+id+"&content="+content;
	postajax("",url,args);
}
function edit_done(id){
var did="edit_area"+id;
var t=document.getElementById(did);
var content=t.innerHTML;
update(id,content);
alert();
}

function edit(id){
var did="todo_content_div"+id;
var d=document.getElementById(did);
var content=d.innerHTML;

var childs = d.childNodes;

for(var i = childs.length - 1; i >= 0; i--) {
var tag=childs[i].tagName;
//alert("fsd");
if (typeof(tag) != "undefined" && tag.toLowerCase() == "textarea") {
return;
}
}

 	var reg=new RegExp("<br>","g");
    var cont=content.replace(reg,'\\n');

var t = document.createElement("textarea");
t.id="edit_area"+id;
t.class="edit_area";
t.cols="50";
t.rows="5";
d.innerHTML="";
t.innerHTML=cont;
d.appendChild(t);


var b = document.createElement("button");

b.id="edit_btn"+id;
b.class="edit_btn";
b.innerHTML="OK";

d.appendChild(b);
b.onclick=function(){
edit_done(id);
};
//<button class="todo_edit_btn" onclick="edit_done($row[task_id])">OK</button>
}


function done(id){
    var url="done_todo.php";
	var args="id="+id;
	postajax("",url,args);
}
function check_done(id){
    if(this.checked=="checked"){
        this.checked="";
    }else{
        this.checked="checked";
        done(id);
    }
}

function postajax(id,url,args){

	 var xmlhttp;
if (window.XMLHttpRequest)
  {// code for IE7+, Firefox, Chrome, Opera, Safari
  xmlhttp=new XMLHttpRequest();
  }
else
  {// code for IE6, IE5
  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
xmlhttp.onreadystatechange=function()
  {
  if (xmlhttp.readyState==4 && xmlhttp.status==200)
    {
    var rt=xmlhttp.responseText;
    if (rt=="wrong"){
        document.getElementById(id).innerHTML="失败";
        return;
    }
    else{
history.go(0);
    }
    }
  }
xmlhttp.open("POST",url,true);
xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
xmlhttp.send(args);
 }

 function submit(){

	var content=document.getElementById("new_task_input").value;
 	if(content==''){document.getElementById("info_out").innerHTML="不能为空。";return;}
 	var reg=new RegExp("\\n","g");
    var content_html=content.replace(reg,'<br>');
    var url="add_todo.php";
	var args="content="+content_html;

	postajax("info_out",url,args);

 }
</script>
</body>
</html>
FOOT;


?>
